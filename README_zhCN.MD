[English](README.MD) | 简体中文
## Jamella's Diablo 2 Hero Editor ##
###### Visual Studio 2019完整源代码和项目文件
---------------------------------------------------------------
以前玩暗黑2的时候就下载过JamellaD2E这个工具，硬啃半生不熟的英语来修改角色和装备，当时就觉得这工具太牛逼了，给我幼小的心灵带来了极大的震撼，现在无意中居然发现了这工具的源代码，太巧了。

---------------------------------------------------------------
#### 说明
JamellaD2E的源代码是以一个PDF文件发布的，源文件在此：[jamella-diablo-ii-source-code.pdf](docs/jamella-diablo-ii-source-code.pdf)

我已经把代码全部复制出来了，建立了项目，现在可以在VS2019里编译链接生成了。

以下是PDF源文件中Jamella的发布说明：
>---------------------------------------------------------------
> #### <center>Jamella’s Diablo 2 Editor的源代码</center>
> #### <center>2001-03-17</center>
>
>这份源代码是我的知识产权，完全由我自己编写，现在发布出来以便于程序猿们及其他有兴趣的人可以研究下它的内部实现。
>
>如果你使用了这份代码中的一部分，请想一想我曾经花了大半年的时间来写这个程序，如果你不介意，请在你的程序的<关于>对话框中标出我的名字。
>
>除此之外，你会发现我在发布编辑器3.0版本后所做的一些修改，所以如果您发现一些额外的功能和无用的代码段，请不要感到惊讶。
>
>同时请不要给我发邮件问如何让这份代码跑起来，因为他就是这么跑起来的，而且我没有时间来教你如何使用C++面向对象编程。
>现在，从阅读头文件开始了解这份代码吧。
>
>
>Jamella
>
>http://jamella.cjb.net
>
>jamella@gmx.net
>
>---------------------------------------------------------------

#### 收集源代码:
```
1. 用<Google Chrome>浏览器打开PDF文件.
2. 复制粘贴所有内容到<pdf.txt>.
3. 从txt文件中删除PDF第一页的内容(readme部分).
4. 用正则表达式同时拿到每一页的文件名和文件内容.
5. 保存为源代码文件.
```

正则表达式的相关步骤在这个文件里: [index.ts](typescript/index.ts)

这份脚本是用TypeScript编写，NodeJS运行的，现在已经不需要再运行了。

源代码现在还不能编译，因为还有一些问题需要解决。

---------------------------------------------------------------
#### 换行问题

首先，大部分文件中都会有换行问题，源代码会在错误的位置换行，比如在字符串中间，出现此问题是因为PDF文件会自动把过长的行自动换行，所以我用VS2019和VSCode格式化并且修改了所有的文件，以确保在用VS2019查看代码的时候不会出现错误。

---------------------------------------------------------------
#### 收集资源文件

所有源代码文件准备好了以后，我们需要补齐那些在[JamellaD2E.rc](vs2019/JamellaD2E/JamellaD2E.rc)中声明了但是手里却没有的资源文件。

我在GitHub上找到了一位同志，他做了跟我几乎一样的事，我从他的仓库里拿到了大部分丢失的资源文件。

这是他的仓库: [Nedkali/JamellaD2E](https://github.com/Nedkali/JamellaD2E)

但这也不全，所以我用脚本把一张明显的错误图像复制到了所有丢失的资源文件的路径。

然后我从`JamellaD2E.exe v4.0beta 9c`版本的EXE中提取了一部分丢失的文件，包括光标、D2S文件和标志性的音效，这依然不够，还缺少3个RTF格式的帮助文件，不过对于我们的目标来说并不需要，所以我只是放了3个空文件并改成他们的路径。

---------------------------------------------------------------
#### 关于资源文件

貌似源代码的程序版本是3.0版，但是我手上并没有3.0版的EXE文件，看起来所有丢失的文件都能从3.0版的EXE里找出来。

我放进去的D2S文件明显版本有问题，不过考虑到这些D2S文件只是用来当做新人物的模板，并没有什么特别大的影响，就这么着也没啥问题。也许如果从3.0版本的EXE里提取出来的会是正确的版本。

如果你手上有`JamellaD2E v3.0`版本的EXE文件，请发给我，这会对本项目有很大的帮助。

---------------------------------------------------------------
#### 编译

##### 关于警告
在编译过程中会有很多警告，原因是这项目是用VC6写的，所以我在项目中禁用了下面这些警告。
```
26451;6328;28183;6011;6386;4996;4552;4477;4554;4474;4258;
```

##### 循环问题
源代码中有个很有趣的事情，Jamella写循环的风格是下面这样的：
```
for (int i = 0; i < 100; i++>) {
    // 代码...
}

// 代码...
int a = i; // 他并没有声明变量i，就直接使用了，因为在上面的循环中已经声明过了
```
这个习惯在VS2019中会报错，所以我把这些在编译中会报错的的代码全都做了修改。

##### CRT警告
因为这项目是VC6时代的,VS提供的C运行库到现在已经有了很大的变化，我不得不加上`_CRT_SECURE_NO_WARNINGS`宏来保证不再出现CRT警告。

##### 宏
JamellaD2E看起来有两个项目，你可以在`JamellaD2E.h`中看到：
* Jamella's Diablo 2 Hero Editor
* Jamella's COM Object

他用宏来控制代码中的声明部分

宏|项目
---|:---:
`JAMELLAEDITOR`|Jamella's Diablo 2 Hero Editor
`JAMELLACOMSERVER`|Jamella's COM Object

我为此项目添加了`JAMELLAEDITOR`宏。
在`JamellaD2E.h`中仍然有很多宏，如果你有兴趣可以自己看看。

##### 字符串常量问题
在VC6年代，你可以像下面这样写代码，并且没有警告和错误：
```
char* sz = "Hello, World.";
```
现在在VS2019中，他会报警告和错误，必须得这么写才行：
```
const char* sz = "Hello, World.";
```
为了解决这个问题，我修改了项目的`符合模式`为否，并且禁用了`SDL检查`。

---------------------------------------------------------------
#### 链接
现在我们可以编译所有文件了，但是在链接时会缺少一些静态导入库。
* `comctl32.lib` 用于Windows通用组件库。
* `Winmm.lib` 用于播放声音。

我已经将他们加入了项目配置中。

---------------------------------------------------------------
#### 结束
以上工作都做完后，终于得到了一个自己生成出的JamellaD2E，我的目的仅此而已，现在可以生成和调试了，并且可以看看他是怎么实现的。

---------------------------------------------------------------
* `Jamella`编写并开源
* `zhaoleimxd`转换为VS2019项目
* 特别感谢`Nedkali`提供的资源文件

2021-10-08
